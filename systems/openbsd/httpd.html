<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>httpd</title>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
</head>
<body>
<div id="content">
<h1 class="title">httpd</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">documentation</a></li>
<li><a href="#sec-2">resources</a></li>
<li><a href="#sec-3">files and scripts</a></li>
<li><a href="#sec-4">some basic examples</a>
<ul>
<li><a href="#sec-4-1">basic server example</a></li>
<li><a href="#sec-4-2">password protected example</a></li>
<li><a href="#sec-4-3">https example</a></li>
</ul>
</li>
<li><a href="#sec-5">Let's Encrypt</a>
<ul>
<li><a href="#sec-5-1">setup</a></li>
<li><a href="#sec-5-2">renew certificates</a></li>
</ul>
</li>
<li><a href="#sec-6">application servers</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">documentation</h2>
<div class="outline-text-2" id="text-1">
<pre class="example">
man 8 httpd

man 5 httpd.conf

man 1 acme-client

man 8 oscpcheck

man 1 htpasswd

man 8 rcctl
</pre>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">resources</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><a href="https://tribaal.io/this-now-served-by-openbsd.html">https://tribaal.io/this-now-served-by-openbsd.html</a>
</li>
<li><a href="http://bluepilltech.blogspot.ie/2015/05/configuring-tlsssl-on-openbsd-57s-httpd.html">http://bluepilltech.blogspot.ie/2015/05/configuring-tlsssl-on-openbsd-57s-httpd.html</a>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">files and scripts</h2>
<div class="outline-text-2" id="text-3">
<pre class="example">
/etc/httpd.conf  ; configuration file

/var/www/htdocs/ ; default root folder

/etc/rc.d/httpd  ; server script

/etc/rc.conf
  httpd-flags=NO

/etc/rc/conf.local
</pre>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">some basic examples</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">basic server example</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<code>directory index ; add to httpd.conf</code>
</p>

<div class="org-src-container">

<pre class="src src-sh">server <span style="color: #8b2252;">"default"</span> {
    directory auto index
}
types { include <span style="color: #8b2252;">"/usr/share/misc/mime.types"</span> }
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">password protected example</h3>
<div class="outline-text-3" id="text-4-2">
<ol class="org-ol">
<li>create htpasswd file in <code>/var/www</code>
<ul class="org-ul">
<li><code>htpasswd /var/www/htpasswd homer</code>
</li>
</ul>
</li>
<li>need to update <code>/etc/httpd.conf</code>
<ul class="org-ul">
<li><code>authenicate with htpasswd ; where htpasswd is the password file</code>
</li>
</ul>
</li>
<li>make <code>/var/www/htpasswd</code> readable by <code>www</code>
<ul class="org-ul">
<li><code>chown www /var/www/htpasswd</code>
</li>
</ul>
</li>
<li>restart <code>httpd</code>
<ul class="org-ul">
<li><code>sh /etc/rc.d/httpd -f restart</code>
</li>
</ul>
</li>
</ol>

<div class="org-src-container">

<pre class="src src-sh">server <span style="color: #8b2252;">"default"</span> {
    directory auto index
    authenticate with htpasswd
}
types { include <span style="color: #8b2252;">"/usr/share/misc/mime.types"</span> }
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3">https example</h3>
<div class="outline-text-3" id="text-4-3">
<ol class="org-ol">
<li>generate server keys

<div class="org-src-container">

<pre class="src src-sh">openssl genrsa -out /etc/ssl/private/server.key
openssl req -new -x509 -key /etc/ssl/private/server.key -out /etc/ssl/server.crt -days 3650
</pre>
</div>
</li>

<li>update <code>/etc/httpd.conf</code>

<div class="org-src-container">

<pre class="src src-sh">server <span style="color: #8b2252;">"default"</span> {
    listen on * tls port 443
    hsts
    directory auto index
    authenticate with htpasswd
}
types { include <span style="color: #8b2252;">"/usr/share/misc/mime.types"</span> }
</pre>
</div>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Let's Encrypt</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">setup</h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>make directory
<ul class="org-ul">
<li><code>mkdir /etc/ssl/acme/example/</code>
</li>
</ul>
</li>
<li>configure <code>/etc/acme-client.conf</code>
<div class="org-src-container">

<pre class="src src-sh">authority letsencrypt {
    api url <span style="color: #8b2252;">"https://acme-v01.api.letsencrypt.org/directory"</span>
    account key <span style="color: #8b2252;">"/etc/acme/letsencrypt-privkey.pem"</span>
}

authority letsencrypt-staging {
    api url <span style="color: #8b2252;">"https://acme-staging.api.letsencrypt.org/directory"</span>
    account key <span style="color: #8b2252;">"/etc/acme/letsencrypt-staging-privkey.pem"</span>
}

domain example.com {
    alternative names { www.example.com }
    domain key <span style="color: #8b2252;">"/etc/ssl/acme/example/example.key"</span>
    domain certificate <span style="color: #8b2252;">"/etc/ssl/acme/example/example.crt"</span>
    domain full chain certificate <span style="color: #8b2252;">"/etc/ssl/acme/example/example.fullchain.pem"</span>
    sign with letsencrypt
}
</pre>
</div>
</li>

<li>configure /etc/httpd.conf

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #b22222;"># </span><span style="color: #b22222;">permanent redirect</span>
server <span style="color: #8b2252;">"example.com"</span> {
    listen on * port 80
    block return 301 <span style="color: #8b2252;">"https://$SERVER_NAME$REQUEST_URI"</span>
}

server <span style="color: #8b2252;">"example.com"</span> {
    listen on * tls port 443
    tls certificate <span style="color: #8b2252;">"/etc/ssl/acme/example/example.fullchain.pem"</span>
    tls key <span style="color: #8b2252;">"/etc/ssl/acme/example/example.key"</span>
    tls ocsp <span style="color: #8b2252;">"/etc/ssl/acme/example/example.der"</span>
    location <span style="color: #8b2252;">"/.well-known/acme-challenge/*"</span> {
        root <span style="color: #8b2252;">"/acme"</span>
        request strip 2
        directory no auto index
    }
    root <span style="color: #8b2252;">"/htdocs"</span>
    location <span style="color: #8b2252;">"/private/*"</span> {
        authenticate with <span style="color: #8b2252;">"/htpasswords"</span>
        directory auto index
    }
}
</pre>
</div>
</li>

<li>acme-client
<ul class="org-ul">
<li><code>acme-client -vvAD www.example.com</code>
</li>
</ul>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">renew certificates</h3>
<div class="outline-text-3" id="text-5-2">
<ol class="org-ol">
<li>remove old certs

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/ssl/acme/example
rm example.crt example.der example.fullchain.pem
</pre>
</div>
</li>

<li>letsencrypt

<div class="org-src-container">

<pre class="src src-sh">acme-client -vD example.com

this creates
/etc/ssl/acme/example/example.crt
/etc/ssl/acme/example/example.fullchain.pem
</pre>
</div>
</li>

<li>ocsp (online certificate status protocol)

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #483d8b;">cd</span> /etc/ssl/acme/example
ocspcheck -No example.der example.fullchain.pem

this creates 
/etc/ssl/acme/example/example.der
</pre>
</div>
</li>

<li>reload httpd

<div class="org-src-container">

<pre class="src src-sh">rcctl reload httpd
</pre>
</div>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">application servers</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>php
</li>
<li>tomcat
</li>
</ul>

<p>
<a href="./openbsd.html">back</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="validation"></p>
</div>
</body>
</html>
